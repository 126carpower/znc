prefix      := @prefix@
exec_prefix := @exec_prefix@
datarootdir := @datarootdir@
bindir      := @bindir@
datadir     := @datadir@
sysconfdir  := @sysconfdir@
libdir      := @libdir@
sbindir     := @sbindir@
localstatedir := @localstatedir@
CXX      := @CXX@
CXXFLAGS := @CXXFLAGS@
LDFLAGS  := @LDFLAGS@
INCLUDES := @INCLUDES@
LIBS     := @LIBS@

SRCS := String.cpp Csocket.cpp main.cpp znc.cpp User.cpp IRCSock.cpp Client.cpp DCCBounce.cpp \
	DCCSock.cpp Chan.cpp Nick.cpp Server.cpp Modules.cpp MD5.cpp Buffer.cpp Utils.cpp \
	FileUtils.cpp HTTPSock.cpp Template.cpp ClientCommand.cpp
OBJS := $(patsubst %cpp,%o,$(SRCS))
CLEAN := znc *.o core core.*
DISTCLEAN := Makefile config.log config.status znc-config znc-buildmod .depend \
	modules/.depend modules/Makefile man/Makefile

.PHONY: all man modules clean distclean install

all: znc man @MODTARGET@

znc: $(OBJS)
	$(CXX) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)

man:
	@$(MAKE) -C man

modules:
	@if test -n "@MODTARGET@"; then \
		$(MAKE) -C modules; \
	else \
		echo "Modules are not enabled"; \
	fi

clean:
	rm -rf $(CLEAN)
	@if test -n "@MODTARGET@"; then \
		$(MAKE) -C modules clean; \
	fi
	@$(MAKE) -C man clean

distclean: clean
	rm -rf $(DISTCLEAN)

%.o: %.cpp
	@mkdir -p .depend
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c -o $@ $< -MMD -MF .depend/$<.dep

install: znc @MODTARGET@
	mkdir -p $(DESTDIR)$(bindir)
	mkdir -p $(DESTDIR)$(prefix)/include/znc
	install -m 0755 znc $(DESTDIR)$(bindir)
	install -m 0755 znc-config $(DESTDIR)$(bindir)
	install -m 0755 znc-buildmod $(DESTDIR)$(bindir)
	install -m 0644 *.h $(DESTDIR)$(prefix)/include/znc
	@if test -n "@MODTARGET@"; then \
		$(MAKE) -C modules install DESTDIR=$(DESTDIR); \
	fi
	@$(MAKE) -C man install DESTDIR=$(DESTDIR)

-include $(wildcard .depend/*.dep)
