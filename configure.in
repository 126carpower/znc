AC_INIT
AC_PROG_CXX
AC_CANONICAL_HOST
CXXFLAGS="-D_GNU_SOURCE"
INCLUDES=""
LIBS=""
function appendLib {
	if test "$LIBS" != ""; then
		LIBS="$LIBS $*"
	else
		LIBS=$*
	fi
}

function appendInc {
	if test "$INCLUDES" != ""; then
		INCLUDES="$INCLUDES $*"
	else
		INCLUDES=$*
	fi
}

function appendCXX {
	if test "$CXXFLAGS" != ""; then
		CXXFLAGS="$CXXFLAGS $*"
	else
		CXXFLAGS=$*
	fi
}
if `echo $host_os | grep -i 'freebsd' >/dev/null 2>/dev/null`; then
	appendInc -I/usr/local/include
	appendLib -L/usr/local/lib -lcompat
elif `echo $host_os | grep -i 'sol' >/dev/null 2>/dev/null`; then
	appendLib -lsocket -lnsl
	ISSUN=1
fi

AC_ARG_WITH( openssl, [  --with-openssl=/path/to/openssl], OPENSSL=$withval,)
AC_ARG_ENABLE( debug, [  --enable-debug  enable debuging], appendCXX -Wall -ggdb -D_DEBUG, appendCXX -Wall -s -O2 -fomit-frame-pointer )
AC_ARG_ENABLE( modules, [  --disable-modules  disable modules], MODULES="no", MODULES="yes")
AC_ARG_ENABLE( openssl, [  --disable-openssl  disable openssl], NOSSL=1,)
AC_ARG_ENABLE( perl, [  --disable-perl  disable perl], NOPERL=1,)

AC_CHECK_FUNCS( stat lstat chmod open, , echo "Missing Required libc feature" && exit 1)
if test "$MODULES" = "yes"; then
	AC_CHECK_FUNC( dlopen,NOCHECK_DL=1,)
fi

if test -z "$NOSSL"; then
	if test -n "$OPENSSL"; then
		appendLib -L${OPENSSL}/lib
		appendInc -I${OPENSSL}/include
	fi

	AC_CHECK_LIB( crypto, BIO_new,,NOSSL=1, )
	AC_CHECK_LIB( ssl, SSL_shutdown,,NOSSL=1, )

	if test -z "$NOSSL"; then
		appendCXX -DHAVE_LIBSSL
	fi
fi

if test -z "$prefix" || test $prefix = "NONE"; then
	prefix="/usr/local"
fi

if test "$MODULES" = "yes"; then
	if test -z "$NOCHECK_DL"; then
		AC_CHECK_LIB( dl, dlopen,,MODULES="no",)
	fi
	if test "$MODULES" = "yes"; then
		appendCXX -D_MODULES
		if test -n "$ISSUN"; then
			MODFLAGS="$CXXFLAGS"
		else
			MODFLAGS="$CXXFLAGS"
			appendCXX -rdynamic
		fi
		MODFLAGS="$MODFLAGS -I`pwd`"
		MODTARGET="modules"
		if test -z "$NOCHECK_DL"; then
			appendLib -ldl
		fi
		if test -n "$ISSUN"; then
			MODFLAGS="$MODFLAGS -mimpure-text"
		fi

		appendCXX "-D_MODDIR_=\\\"${prefix}/share/znc\\\""

		if test -z "$NOPERL"; then
			echo -n "checking for perl... "
			PERL=`which perl`
			if test -n "$PERL"; then
				echo "$PERL"
				AC_CHECK_LIB( perl, perl_alloc,unset NOPERL, unset PERL,[`$PERL -MExtUtils::Embed -e ccopts -e ldopts`])
			else
				echo "no"
				unset PERL
			fi
		fi
	fi
fi

VERSION=`grep '#define VERSION' Modules.h | awk '{print $3}'`
#
# Auto detect modules

AC_SUBST([CXXFLAGS])
AC_SUBST([MODFLAGS])
AC_SUBST([INCLUDES])
AC_SUBST([LIBS])
AC_SUBST([MODULES])
AC_SUBST([MODTARGET])
AC_SUBST([VERSION])
AC_SUBST([NOSSL])
AC_SUBST([PERL])
AC_CONFIG_FILES([Makefile])
AC_CONFIG_FILES([znc-config])
if test "$MODULES" = "yes"; then
	AC_CONFIG_FILES([modules/Makefile])
fi
AC_OUTPUT
