ifneq ($(MAKE),gmake)
# If you got an ERROR on the previous line, then you aren't using gmake
endif

CXX=g++
CXXFLAGS=@CXXFLAGS@
INCLUDES=@INCLUDES@
LIBS=@LIBS@

OBJS=main.o znc.o User.o IRCSock.o UserSock.o DCCBounce.o DCCSock.o Chan.o Nick.o Server.o Modules.o md5.o Buffer.o Utils.o
SRCS=main.cpp znc.cpp User.cpp IRCSock.cpp UserSock.cpp DCCBounce.cpp DCCSock.cpp Chan.cpp Nick.cpp Server.cpp Modules.cpp md5.cpp Buffer.cpp Utils.cpp

all: znc @MODTARGET@

depend::
	g++ -MM $(CXXFLAGS) $(SRCS) $(INCLUDES) >.depend
	(cd modules; $(MAKE) depend)

znc: $(OBJS)
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o $@ $(LIBS) $(OBJS)

znc-static: $(OBJS)
	$(CXX) $(CXXFLAGS) -static -o $@ $(INCLUDES) $(OBJS) $(LIBS)
	strip $@

modules::
	(cd modules; $(MAKE) all)

clean:
	rm -rf znc znc-static *.o core core.*
	(cd modules; $(MAKE) clean)

-include .depend

%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c -o $*.o $*.cpp

install: znc @MODTARGET@
	mkdir -p $(DEST)
	install -m 0711 znc $(DEST)
	(cd modules; $(MAKE) DEST=$(DEST))	
