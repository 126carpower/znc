prefix=@prefix@
CXX=@CXX@
CXXFLAGS=@CXXFLAGS@
INCLUDES=@INCLUDES@ -I..
LIBS=@LIBS@
PERL=@PERL@
ifneq "$(PERL)" ""
PERLCC=-DHAVE_PERL `$(PERL) -MExtUtils::Embed -e ccopts`
PERLLD=`$(PERL) -MExtUtils::Embed -e ccopts -e ldopts`
endif
VPATH=.:..

ifeq "@NOSSL@" "1" 
TARGETS=$(foreach file, $(wildcard *.cpp), $(if $(shell grep REQUIRESSL $(file)),, $(addsuffix .so, $(basename $(file)))))
INSTALL_TARGS=$(foreach file, $(wildcard *.cpp), $(if $(shell grep REQUIRESSL $(file)),, install_$(addsuffix .so, $(basename $(file)))))
OBJS=$(foreach file, $(wildcard *.cpp), $(if $(shell grep REQUIRESSL $(file)),, $(addsuffix .o, $(basename $(file)))))
SRCS=$(wildcard ../*.cpp) $(foreach file, $(wildcard *.cpp), $(if $(shell grep REQUIRESSL $(file)),,$(file)))
else
TARGETS=$(addsuffix .so, $(basename $(wildcard *.cpp)))
INSTALL_TARGS=$(foreach file, $(addsuffix .so, $(basename $(wildcard *.cpp))), install_$(file))
OBJS=$(addsuffix .o, $(basename $(wildcard *.cpp)))
SRCS=$(wildcard *.cpp) $(wildcard ../*.cpp)
endif

all: $(OBJS) $(TARGETS)

depend::
	$(CXX) -MM $(CXXFLAGS) $(SRCS) $(INCLUDES) $(PERLCC) >.depend

install: all create_install_dir install_metadirs $(INSTALL_TARGS)
	@echo -n ""

create_install_dir:
	mkdir -p $(DESTDIR)$(prefix)/share/znc
	rm -rf $(DESTDIR)$(prefix)/share/znc/*.so

install_metadirs:
	for a in *; do \
		if [ -d $$a ] && [ -f $${a}.so ]; then \
			cp -Rp $$a $(DESTDIR)$(prefix)/share/znc; \
		fi \
	done

install_%:
	install -m 0755 $(subst install_,,$@) $(DESTDIR)$(prefix)/share/znc

clean:
	rm -rf *.so *.o core core.*

-include .depend

%.so: %.o
	$(CXX) $(CXXFLAGS) -shared -o $@ $< $(INCLUDES) $(LIBS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c -o $@ $<

ifneq "$(PERL)" ""
modperl.so: modperl.o
	$(CXX) $(CXXFLAGS) -shared -o $@ $< $(INCLUDES) $(LIBS) $(PERLLD)

modperl.o: modperl.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c -o $@ modperl.cpp $(PERLCC)
install_modperl.so:
	install -m 0755 modperl.so $(DESTDIR)$(prefix)/share/znc
	for i in *.pm; do \
		install -m 0755 $$i $(DESTDIR)$(prefix)/share/znc; \
	done
else
modperl.so:
	@echo -n ""
modperl.o:
	@echo -n ""
install_modperl.so:
	@echo -n ""
endif
